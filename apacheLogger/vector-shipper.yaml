data_dir: '/home/jitte/unilogs/vector_data'

sources:
  app_logs:
    type: file
    include:
      - /home/jitte/unilogs/apacheLogger/logs/app.log

transforms:
  parse_logs:
    type: remap
    inputs:
      - app_logs
    source: |
      # Parse Apache combined with ISO-8601 timestamp
      parsed, err = parse_apache_log(
        .message,
        "combined",
        "%Y-%m-%dT%H:%M:%S.%3fZ"
      )

      if err != null {
        log("Failed to parse log line: " + string!(err), level: "error")
      } else {
        . = merge(., parsed)
        .unilogs_service_label = "test"

        if .path == "/" {
          .level = "info"
        } else {
          .level = split(.path, "/")[1] ?? "unknown"
        }
      }

sinks:
  kafka:
    type: kafka
    inputs:
      - parse_logs
    bootstrap_servers: 'a181c5b3980e5414ea51da70abf44b39-c85da5ba1220a4a8.elb.eu-north-1.amazonaws.com:9095, a87911897e8eb48d097666f49422f02c-ba1dda181e731ea1.elb.eu-north-1.amazonaws.com:9095, af107ac24d2ea4897aafb411040bc17b-8c932a319f00a76b.elb.eu-north-1.amazonaws.com:9095'
    topic: app_logs_topic
    encoding:
      codec: json
    sasl:
      enabled: true
      username: 'vector-user'
      password: 'vector-password' # Ensure this EXACTLY matches the password in CDK/Helm
      mechanism: 'PLAIN'
    tls:
      enabled: true
      ca_file: '/home/jitte/unilogs/apacheLogger/ca.crt'
      verify_hostname: false # <-- ADD THIS TEMPORARILY

  console:
    type: console
    inputs:
      - parse_logs
    encoding:
      codec: json
