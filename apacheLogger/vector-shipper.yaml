data_dir: '/home/jitte/unilogs/vector_data'

sources:
  app_logs:
    type: file
    include:
      - /home/jitte/unilogs/apacheLogger/logs/app.log

transforms:
  parse_logs:
    type: remap
    inputs:
      - app_logs
    source: |
      # Parse Apache combined with ISO-8601 timestamp
      parsed, err = parse_apache_log(
        .message,
        "combined",
        "%Y-%m-%dT%H:%M:%S.%3fZ"
      )

      if err != null {
        log("Failed to parse log line: " + string!(err), level: "error")
      } else {
        . = merge(., parsed)
        .unilogs_service_label = "apacheLogger"

        if .path == "/" {
          .level = "info"
        } else {
          .level = split(.path, "/")[1] ?? "unknown"
        }
      }

sinks:
  kafka:
    type: kafka
    inputs:
      - parse_logs
    bootstrap_servers: 'a9d097ca1663947739ecb5da7b170793-59b06c4dfac2a21e.elb.eu-north-1.amazonaws.com:9095, ad88153877f6f481aaf7ef2ffb6bfec8-50bcc10389580e6d.elb.eu-north-1.amazonaws.com:9095, ab63145c59c5346f4b6ab128b57c614a-072dd64b4e5ce015.elb.eu-north-1.amazonaws.com:9095'
    topic: app_logs_topic
    encoding:
      codec: json
    sasl:
      enabled: true
      username: 'vector-user'
      password: 'vector-password' # Ensure this EXACTLY matches the password in CDK/Helm
      mechanism: 'PLAIN'
    tls:
      enabled: true
      ca_file: '/home/jitte/unilogs/ca.crt'
      verify_hostname: false # <-- ADD THIS TEMPORARILY

  console:
    type: console
    inputs:
      - parse_logs
    encoding:
      codec: json
