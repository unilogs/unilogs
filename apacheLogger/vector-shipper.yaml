data_dir: '/Users/davidpark/Desktop/unilogs/vector_data'

sources:
  app_logs:
    type: file
    include:
      - /Users/davidpark/Desktop/unilogs/apacheLogger/logs/app.log

transforms:
  parse_logs:
    type: remap
    inputs:
      - app_logs
    source: |
      # Parse Apache combined with ISO-8601 timestamp
      parsed, err = parse_apache_log(
        .message,
        "combined",
        "%Y-%m-%dT%H:%M:%S.%3fZ"
      )

      if err != null {
        log("Failed to parse log line: " + string!(err), level: "error")
      } else {
        . = merge(., parsed)
        .unilogs_service_label = "apacheLogger"

        if .path == "/" {
          .level = "info"
        } else {
          .level = split(.path, "/")[1] ?? "unknown"
        }
      }

sinks:
  kafka:
    type: kafka
    inputs:
      - parse_logs
    bootstrap_servers: 'a58b54e386a0149288553908e5a32306-7d7edb010e8264b3.elb.eu-north-1.amazonaws.com:9095, a32b2eaad791947f6b448ccbbc4513e9-727ec516e00c38e5.elb.eu-north-1.amazonaws.com:9095, a6626a98dd9594266b13e01045a26a8f-ea0cde6914be4839.elb.eu-north-1.amazonaws.com:9095'
    topic: app_logs_topic
    encoding:
      codec: json
    sasl:
      enabled: true
      username: 'vector-user'
      password: 'vector-password' # Ensure this EXACTLY matches the password in CDK/Helm
      mechanism: 'PLAIN'
    tls:
      enabled: true
      ca_file: '../unilogs-cdk/ca.crt'
      verify_hostname: false # <-- ADD THIS TEMPORARILY

  console:
    type: console
    inputs:
      - parse_logs
    encoding:
      codec: json
